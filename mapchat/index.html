<!DOCTYPE html>

<html>
<head>
	<title> Mapchat </title>
	<meta name="viewport" content="initial-scale=1.0, user-scalable=no" />
	<script type="text/javascript" src="https://maps.googleapis.com/maps/api/js?sensor=true"></script>
	<link rel="stylesheet" href="style.css"/>
	
	<script>

		function init() {
			get_my_location();
		}

		/* Getting my location */
		function get_my_location() {

			if (navigator.geolocation) {
				navigator.geolocation.getCurrentPosition(function(position) {
					my_lat = position.coords.latitude;
					my_lng = position.coords.longitude;
					contact_server(my_lat, my_lng);
				});
			} 
			else {
				alert("Your browser doesn't support geolocation!");
			}
		}

		function contact_server(my_lat, my_lng) {
			/* XML request variables */
			var request = new XMLHttpRequest();
			var url = "https://secret-about-box.herokuapp.com/sendLocation";
			var params = "login="+"JanetGage"+"&lat="+my_lat+"&lng="+my_lng+"&message="+"mymessage";
			request.open('POST', 'https://secret-about-box.herokuapp.com/sendLocation', true); 
			
			/* Send proper header information */
			request.setRequestHeader("Content-type", "application/x-www-form-urlencoded");
			request.setRequestHeader("Content-length", params.length);
			request.setRequestHeader("Connection", "close");

			request.onreadystatechange = function () {
				if (request.readyState == 4 && request.status == 200) {
					var response = request.responseText;
					var parsed_objects = JSON.parse(response);
					draw_init_map(parsed_objects, my_lat, my_lng);
					// What do I do with the response?
				}
			}
			request.send(params);

		}

		function draw_init_map(parsed_objects, my_lat, my_lng) {
			console.log("init_map");

			var me = new google.maps.LatLng(my_lat, my_lng);
			var map_options = {
				zoom: 8,
				center: me,
				mapTypeId: google.maps.MapTypeId.ROADMAP
			};

			var map;
			var elem = document.getElementById("map");

			map = new google.maps.Map(elem, map_options);

			for (i = 0; i < parsed_objects.length; i++) {
	    		var id = parsed_objects[i]["_id"];
	    		var login = parsed_objects[i]["login"];
	    		var lat = parsed_objects[i]["lat"];
	    		var lng = parsed_objects[i]["lng"];
	    		var pos = new google.maps.LatLng(lat, lng);
	    		var mess = parsed_objects[i]["message"];

	    		add_marker(map, id, login, pos, mess);
	            // elem.innerHTML += "<p>" + login + "</p>";
				}

		}

		function add_marker(map, id, login, pos, mess) {

			var marker=new google.maps.Marker({
				position: pos,
				title: login
			});

			var contentstring='<div id = "content">'+"<log>"+"login: "+login+"</log>"
													+"<msg>"+"message: "+mess+"</msg>"
													+'</div>'
													
			var infowindow=new google.maps.InfoWindow({
				content: contentString
			});

			marker.addListener('click', function() {
				infowindow.open(map, marker);
			});

			/* Adding marker to map */
			marker.setMap(map);
		}

	</script>


</head>

<body onload="init()">
	<!-- Making the space for the canvas -->
	<div id="map"></div>
	</body>

</html>